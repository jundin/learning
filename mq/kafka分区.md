##发布订阅模式
###消费者pull
优点：消费者的消费速度自己控制
缺点：长轮询 如果没有消息比较浪费资源


## 消费者
### 指定位移消费
```java
public void seek(topicPartition partition, long offset)
```
seek()方法中的partition表示分区，offset参数来指定从分区的哪个位置开始消费。
seek()方法只能重置消费者分配到的分区的消费位置，而分区的分配是在poll()方法的调用过程中实现的。

有时候我们并不知道特定的消费位置，却知道一个确切的时间点，比如我们想要消费昨天8点以后的消息。
KafkaConsumer 提供了一个offset是ForTimes()方法，通过timestamp来查询于此对应的分区位置。

seek()方法为我们提供了从特定位置读取消息的能力，也为我们将消费位移保存在外部存储介质中的能力，还可以配合再均衡监听器来提供更加精准的消费能力。


## 主题与分区 -分区的管理
### 负载不均衡
随着时间的更替，Kafka集群中的broker节点不可避免的会遇到宕机或者崩溃的问题，当分区的leader节点发生故障时，
其中一个follower节点就会成为新的leader节点，这样就会导致集群的负载不均衡，从而影响整体的健壮性和稳定性。
当原来的leader节点恢复之后重新加入集群时，它只能成为一个新的follwer节点而不再对外服务。

### 治理副本失衡 --  优先副本的选举
为了能够有效的治理副本失衡的情况，Kafka引入优先副本的概（preferred replica）概念。
所谓的优先副本是指在AR集合列表中的第一个副本。
所谓的优先副本的选举就是通过一定的方式促使优先副本选举成leader副本，以此来促进集群的负载均衡，这一行为也称为“分区平衡”。

在Kafka中可以提供分区平衡的功能，于此对应的broker端的参数是auto.leader.rebalance.enable,此参数默认值是true。
默认情况下，此功能是开启的。kafka的控制器会启动一个定时任务，轮询所有的broker节点，计算每个broker节点的分区不平衡率。
**broker中的不平衡率 = 非优先副本的leader个数/分区总数**

分区不平衡率 大于 leader.imbalance.per.broker.percentage 参数配置的比值，默认值为10%
如果超过设定的比值则会自动执行优先副本的选举动作以求分区平衡。
执行周期由leader.imbalance.check.interval.second控制，默认值事00秒，即5分钟。

**不过生产环境中不建议将auto.leader.rebalance.enable设置为默认的true，因为这可能负面的性能问题，也可能引起客户端一定时间的阻塞。**

Kafka中kafka-perferred-replica-election.sh脚本提供了对分区leader副本进行重复平衡的功能。
优先副本的选举过程是一个安全的过程，kafka客户端可以自动感知分区leader副本的变更。

将集群中所有的分区都执行一遍优先副本的选举操作，分区数越多打印出来的信息也越多。leader副本的转移也是一项高成本的工作。
如果执行的分区数很多，那么必然会对客户端造成一定的影响。在选举的过程中，具体的元数据也会存入Zookeeper的/admin/preferred_replica_election节点，
如果这些数据超过zk节点所允许的大小，那么选举失败。默认节点大小为1MB。

kafka-perferred-replica-election.sh脚本中还提供path-to-json-file参数来小批量的对部分分区执行优先副本的选举操作。

在实际生产环境中，一般使用path-to-json-file参数分批，手动执行优先副本的选举操作。优先副本的选举操作要避开业务高峰期。

### 分区重分配
当集群中新增broker节点，只有新创建的主题分区才有可能被分配到这个节点上，而之前的主题分区并不会自动分配到新加入的节点中，
这样新节点和原先节点的负载严重不平衡。

为了解决上述问题，需要将分区副本进行合理的分配，也就是所谓的分区重分配。
kafka提供了 kafka-reassign-partitions.sh脚本执行分区重新分配的工作，他可以在集群扩容，broker节点失效的场景下对分区进行迁移。

### 复制限流
分区重分配的本质在于数据复制，先增加新的副本，然后进行数据同步，最后删除旧的副本达到最终的目的。
数据复制会占用额外的资源，如果分区的量太大必然会影响整体的性能。
副本间的限流方式有两种: kafka-config.sh脚本和kafka-reassign-partitions.sh脚本。

### 修改副本因子
修改副本因子的功能也通过重分配所使用的kafka-reassign-partitions.sh脚本来实现。


### 如何选取合适的分区数

实际的业务场景，软件条件，硬件条件，负载情况来做具体的考量。

#### 性能测试工具
生产者性能测试的kafka-producer-perf-test.sh和消费者性能测试的kafka-consumer-perf-test.sh。

####考量因素

当生产者向kafka写入基于key的消息时，kafka基于消息的key来计算出消息将要写入哪个具体的分区，这样具有相同key的数据可以写入同一个分区。
kafka的这一功能对于一部分应用极为重要，比如日志压缩（log Compaction）。再比如用一个Key的所有消息，消费者需要按照消息的顺序进行有序的消费。

有些场景要求主题中的消息都能保证顺序性，这种情况下创建主题分区数为1，通过分区有序性来达到主题有序性的目的。

broker节点只有leader副本对外提供服务。broker宕机，leader副本所属宿主的broker节点上的所有分区将属于不可用状态，
此时kafka控制器负责从follower副本中选取leader用于接收外部客户端的请求。分区在角色切换过程不可用，如果有大量的分区需要同时进行leader角色切换
会耗费一定的时间，在这个时间窗口内这些分区变的不可用。

分区越多kafka的正常启动和关闭耗时变的越长，主题分区数越多不仅增加日志清理的耗时，而且在被删除是也会耗费更多的时间。

建议将分区数设定为集群中broker的倍数，一般集群中有3个broker节点，可以设定分区数为3,6,9等。




